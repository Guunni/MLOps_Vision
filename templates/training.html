<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLOps Vision Platform - 모델 학습</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 기존 CSS 변수들 유지 */
        :root {
            --primary-color: #475569;
            --secondary-color: #64748b;
            --accent-color: #0f172a;
            --success-color: #059669;
            --warning-color: #d97706;
            --error-color: #dc2626;
            --info-color: #2563eb;
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --sidebar-width-collapsed: 60px;
            --sidebar-width: 260px;
            --header-height: 80px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* 앱 컨테이너 */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* 사이드바 스타일 */
        .sidebar {
            width: var(--sidebar-width-collapsed);
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow: hidden;
            z-index: 1000;
            transition: width 0.3s ease;
            border-right: 1px solid var(--border-color);
        }

        .sidebar:hover {
            width: var(--sidebar-width);
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f8fafc;
            opacity: 0;
            transition: opacity 0.3s ease 0.3s;
            white-space: nowrap;
            position: absolute;
            left: 1.5rem;
        }

        .sidebar:hover .sidebar-header h2 {
            opacity: 1;
        }

        .nav-menu {
            list-style: none;
            padding: 1rem 0;
        }

        .nav-menu li {
            margin: 0.25rem 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: rgba(248, 250, 252, 0.8);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            font-weight: 500;
            white-space: nowrap;
            height: 50px;
            position: relative;
        }

        .sidebar:not(:hover) .nav-link {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        .sidebar:hover .nav-link {
            justify-content: flex-start;
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }

        .nav-link:hover {
            background-color: rgba(248, 250, 252, 0.1);
            color: #f8fafc;
            border-left-color: rgba(248, 250, 252, 0.4);
        }

        .nav-link.active {
            background-color: rgba(248, 250, 252, 0.15);
            color: #f8fafc;
            border-left-color: #f8fafc;
            font-weight: 600;
        }

        .nav-link i {
            width: 1.25rem;
            text-align: center;
            opacity: 0.9;
        }

        .nav-text {
            display: none;
        }

        .sidebar:hover .nav-text {
            display: inline;
        }

        /* 메인 콘텐츠 */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width-collapsed);
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .content-header {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .content-header h1 {
            font-size: 1.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .refresh-container {
            position: relative;
            display: inline-block;
        }

        .refresh-tooltip {
            position: absolute;
            right: calc(100% + 10px);
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1001;
        }

        .refresh-tooltip::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: rgba(0, 0, 0, 0.8);
        }

        .refresh-container:hover .refresh-tooltip {
            opacity: 1;
            visibility: visible;
            right: calc(100% + 15px);
        }

        /* 버튼 스타일 */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 학습 설정 섹션 */
        .training-config {
            padding: 2rem;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .config-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        /* 툴팁이 있는 라벨 스타일 */
        .form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .help-icon {
            color: var(--text-muted);
            font-size: 0.875rem;
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            cursor: help;
            flex-shrink: 0;
            /* 크기 고정 */
        }

        /* 툴팁 스타일 개선 */
        .tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1001;
            max-width: 280px;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }

        .help-icon:hover .tooltip {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.1);
        }

        /* 슬라이더와 입력 필드 조합 */
        .range-input-group {
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 0.75rem;
            align-items: center;
        }

        .form-range {
            width: 100%;
            margin: 0;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
        }

        .form-range::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .form-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .range-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            text-align: center;
        }

        .range-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(71, 85, 105, 0.1);
        }

        /* 데이터 분할 섹션 */
        .data-split-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .split-item {
            text-align: center;
        }

        .split-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .split-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* 학습 상태 섹션 */
        .training-status {
            padding: 0 2rem 2rem;
        }

        .status-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-idle {
            background-color: rgba(148, 163, 184, 0.1);
            color: var(--text-muted);
        }

        .status-training {
            background-color: rgba(37, 99, 235, 0.1);
            color: var(--info-color);
        }

        .status-completed {
            background-color: rgba(5, 150, 105, 0.1);
            color: var(--success-color);
        }

        .status-error {
            background-color: rgba(220, 38, 38, 0.1);
            color: var(--error-color);
        }

        .progress-section {
            margin-top: 1rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--info-color));
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* 학습 기록 */
        .training-history {
            padding: 0 2rem 2rem;
        }

        .history-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-info h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .history-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        /* 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .breadcrumb-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .breadcrumb-item {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .breadcrumb-item:hover {
            color: var(--primary-color);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 500;
        }

        .breadcrumb-separator {
            color: var(--text-muted);
        }

        .header-title-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .project-selector {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            min-width: 200px;
            font-size: 0.875rem;
        }

        .project-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(71, 85, 105, 0.1);
        }

        /* 반응형 디자인 */
        @media (max-width: 1024px) {
            .config-grid {
                grid-template-columns: 1fr;
            }

            .data-split-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .content-header {
                padding: 1rem;
            }

            .training-config,
            .training-status,
            .training-history {
                padding: 1rem;
            }

            .range-input-group {
                grid-template-columns: 1fr 100px;
                gap: 0.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- 사이드바 네비게이션 -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>MLOps Vision</h2>
            </div>

            <ul class="nav-menu">
                <li><a href="/dashboard" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i> <span class="nav-text">대시보드</span>
                    </a></li>
                <li><a href="/ui/projects" class="nav-link">
                        <i class="fas fa-folder-open"></i> <span class="nav-text">프로젝트</span>
                    </a></li>
                <li><a href="/ui/datasets" class="nav-link">
                        <i class="fas fa-database"></i> <span class="nav-text">데이터셋</span>
                    </a></li>
                <li><a href="/ui/training" class="nav-link active">
                        <i class="fas fa-brain"></i> <span class="nav-text">모델 학습</span>
                    </a></li>
                <li><a href="/ui/models" class="nav-link">
                        <i class="fas fa-chart-bar"></i> <span class="nav-text">성능 지표</span>
                    </a></li>
                <li><a href="/ui/monitoring" class="nav-link">
                        <i class="fas fa-chart-line"></i> <span class="nav-text">모니터링</span>
                    </a></li>
            </ul>
        </nav>

        <!-- 메인 컨텐츠 영역 -->
        <main class="main-content">
            <!-- 헤더 -->
            <header class="content-header">
                <div class="breadcrumb-container">
                    <nav class="breadcrumb" id="breadcrumbNav">
                        <a href="/dashboard" class="breadcrumb-item">대시보드</a>
                        <span class="breadcrumb-separator">/</span>
                        <a href="/ui/projects" class="breadcrumb-item">프로젝트</a>
                        <span class="breadcrumb-separator" id="projectSeparator" style="display: none;">/</span>
                        <span class="breadcrumb-item" id="selectedProjectBreadcrumb" style="display: none;"></span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item active">모델 학습</span>
                    </nav>
                    <div class="header-title-section">
                        <h1>모델 학습</h1>
                        <select id="projectSelector" class="project-selector">
                            <option value="">프로젝트를 선택하세요</option>
                        </select>
                        <select id="datasetSelectorHeader" class="project-selector" style="display: none;">
                            <option value="">데이터셋을 선택하세요</option>
                        </select>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="refresh-container">
                        <button class="btn btn-primary" onclick="refreshTraining()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <div class="refresh-tooltip">Refresh</div>
                    </div>
                </div>
            </header>

            <!-- 학습 설정 섹션 -->
            <section class="training-config">
                <div class="config-grid">
                    <!-- 기본 설정 -->
                    <div class="config-section">
                        <h3 class="section-title">
                            <i class="fas fa-cog"></i>
                            기본 설정
                        </h3>
                        <div class="form-group">
                            <label class="form-label">
                                프로젝트 선택
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        학습을 진행할 프로젝트를 선택합니다.<br>
                                        프로젝트 내의 데이터셋만 표시됩니다.
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="trainingProjectSelect">
                                <option value="">프로젝트를 선택하세요</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                데이터셋 선택
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        학습에 사용할 데이터셋을 선택합니다.<br>
                                        정상 이미지와 이상 이미지가 포함된<br>
                                        데이터셋이 필요합니다.
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="datasetSelect">
                                <option value="">데이터셋을 선택하세요</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                모델 백본
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        이미지에서 특징을 추출하는 사전 훈련된 모델입니다.<br>
                                        • Wide ResNet-50: 가장 좋은 성능 (권장)<br>
                                        • ResNet-18: 빠른 속도, 가벼운 모델<br>
                                        • ResNet-50: 높은 정확도, 더 무거운 모델<br>
                                        • EfficientNet-B0: 메모리 효율적
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="backboneSelect">
                                <option value="wideresnet50">Wide ResNet-50</option>
                                <option value="resnet18">ResNet-18</option>
                                <option value="resnet50">ResNet-50</option>
                                <option value="efficientnet_b0">EfficientNet-B0</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                학습 타입
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        • 새 학습: 처음부터 완전히 새로 학습<br>
                                        • 전이 학습: 기존 모델을 새 데이터에 맞게 조정<br>
                                        • 재학습: 기존 모델을 완전히 다시 학습<br>
                                        ※처음에는 '새 학습'을 추천합니다.
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="trainingType">
                                <option value="new">새 학습</option>
                                <option value="transfer">전이 학습</option>
                                <option value="retrain">재학습</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                에폭 수
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        전체 데이터를 몇 번 반복해서 학습할지 정합니다.<br>
                                        • 적은 에폭: 학습 부족 가능성<br>
                                        • 많은 에폭: 과학습 가능성<br>
                                        보통 10~50 사이에서 시작합니다.
                                    </div>
                                </i>
                            </label>
                            <input type="number" class="form-input" id="epochs" value="10" min="1" max="1000">
                        </div>
                    </div>

                    <!-- 고급 설정 -->
                    <div class="config-section">
                        <h3 class="section-title">
                            <i class="fas fa-sliders-h"></i>
                            고급 설정
                        </h3>

                        <div class="form-group">
                            <label class="form-label">
                                학습률
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        학습률은 모델이 얼마나 빠르게 학습할지를 결정합니다.<br>
                                        • 너무 크면: 학습이 불안정해지고 성능이 나빠집니다<br>
                                        • 너무 작으면: 학습이 매우 느려집니다<br>
                                        일반적으로 0.001~0.01 사이 값을 사용합니다.
                                    </div>
                                </i>
                            </label>
                            <div class="range-input-group">
                                <input type="range" class="form-range" id="learningRateSlider" min="0.0001" max="0.1"
                                    step="0.0001" value="0.001">
                                <input type="number" class="range-input" id="learningRateInput" min="0.0001" max="0.1"
                                    step="0.0001" value="0.001">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                배치 크기
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        한 번에 처리할 이미지 개수입니다.<br>
                                        • 작은 값(8-16): 메모리 적게 사용, 학습 더 안정적<br>
                                        • 큰 값(32-64): 메모리 많이 사용, 학습 속도 빠름<br>
                                        GPU 메모리에 따라 조정하세요.
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="batchSize">
                                <option value="8">8</option>
                                <option value="16">16</option>
                                <option value="32" selected>32</option>
                                <option value="64">64</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                샘플링 비율
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        전체 특징 중에서 사용할 비율입니다.<br>
                                        PatchCore 알고리즘에서 메모리 절약을 위해<br>
                                        특징을 일부만 선택해서 사용합니다.<br>
                                        0.3 정도가 적절합니다.
                                    </div>
                                </i>
                            </label>
                            <div class="range-input-group">
                                <input type="range" class="form-range" id="samplingRatioSlider" min="0.1" max="1.0"
                                    step="0.1" value="0.3">
                                <input type="number" class="range-input" id="samplingRatioInput" min="0.1" max="1.0"
                                    step="0.1" value="0.3">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                이미지 크기
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        학습에 사용할 각 이미지의 크기입니다.<br>
                                        (배치 크기와는 다릅니다)<br>
                                        • 작은 크기: 빠른 학습, 낮은 정확도<br>
                                        • 큰 크기: 느린 학습, 높은 정확도<br>
                                        256x256이 성능과 속도의 균형점입니다.<br>
                                        권장: <b>이미지 크기 ≤ 리사이즈</b>
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="imageSize">
                                <option value="224">224x224</option>
                                <option value="256" selected>256x256</option>
                                <option value="320">320x320</option>
                                <option value="384">384x384</option>
                                <option value="448">448x448</option>
                                <option value="512">512x512</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                리사이즈(전처리)
                                <i class="fas fa-question-circle help-icon">
                                    <div class="tooltip">
                                        전처리에서 이미지의 해상도를 줄이는 값입니다.<br>
                                        일반적으로 원본을 먼저 리사이즈 후<br>
                                        이미지 크기로 학습에 맞춰 사용합니다.<br>
                                        권장: <b>이미지 크기 ≤ 리사이즈</b>
                                    </div>
                                </i>
                            </label>
                            <select class="form-select" id="resizeSize">
                                <option value="128">128x128</option>
                                <option value="256">256x256</option>
                                <option value="320" selected>320x320</option>
                                <option value="384">384x384</option>
                                <option value="448">448x448</option>
                                <option value="512">512x512</option>
                                <option value="640">640x640</option>
                                <option value="1024">1024x1024</option>
                                <option value="2048">2048x2048</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 데이터 분할 설정 -->
                <div class="config-section" style="margin-top: 2rem;">
                    <h3 class="section-title">
                        <i class="fas fa-chart-pie"></i>
                        데이터 분할 설정
                        <i class="fas fa-question-circle help-icon">
                            <div class="tooltip">
                                전체 데이터를 용도별로 나누는 비율입니다.<br>
                                • 학습용: 모델을 훈련시키는 데이터<br>
                                • 검증용: 학습 중 성능을 확인하는 데이터<br>
                                • 테스트용: 최종 성능을 평가하는 데이터<br>
                                합계는 항상 100% 가 됩니다.
                            </div>
                        </i>
                    </h3>
                    <div class="data-split-grid">
                        <div class="form-group">
                            <label class="form-label">학습 데이터</label>
                            <div class="range-input-group">
                                <input type="range" class="form-range" id="trainRatioSlider" min="50" max="90" step="1"
                                    value="70">
                                <input type="number" class="range-input" id="trainRatioInput" min="50" max="90" step="1"
                                    value="70">
                            </div>
                            <div class="split-item">
                                <div class="split-percentage" id="trainPercentage">70%</div>
                                <div class="split-label">학습</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">검증 데이터</label>
                            <div class="range-input-group">
                                <input type="range" class="form-range" id="valRatioSlider" min="10" max="40" step="1"
                                    value="20">
                                <input type="number" class="range-input" id="valRatioInput" min="10" max="40" step="1"
                                    value="20">
                            </div>
                            <div class="split-item">
                                <div class="split-percentage" id="valPercentage">20%</div>
                                <div class="split-label">검증</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">테스트 데이터</label>
                            <div class="range-input-group">
                                <input type="range" class="form-range" id="testRatioSlider" min="0" max="40" step="1"
                                    value="10">
                                <input type="number" class="range-input" id="testRatioInput" min="0" max="40" step="1"
                                    value="10">
                            </div>
                            <div class="split-item">
                                <div class="split-percentage" id="testPercentage">10%</div>
                                <div class="split-label">테스트</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 학습 시작 버튼 -->
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="btn btn-success" onclick="startTraining()" id="startBtn"
                        style="padding: 1rem 2rem; font-size: 1rem;">
                        <i class="fas fa-play"></i> 학습 시작
                    </button>
                    <button class="btn btn-danger" onclick="stopTraining()" id="stopBtn"
                        style="padding: 1rem 2rem; font-size: 1rem; display: none;">
                        <i class="fas fa-stop"></i> 학습 중단
                    </button>
                </div>
            </section>

            <!-- 현재 학습 상태 -->
            <section class="training-status">
                <div class="status-card">
                    <div class="status-header">
                        <h3 class="section-title">
                            <i class="fas fa-chart-line"></i>
                            현재 학습 상태
                        </h3>
                        <span class="status-badge status-idle" id="statusBadge">대기중</span>
                    </div>

                    <div id="trainingInfo" style="display: none;">
                        <p><strong>모델:</strong> <span id="currentModel">-</span></p>
                        <p><strong>데이터셋:</strong> <span id="currentDataset">-</span></p>
                        <p><strong>시작 시간:</strong> <span id="startTime">-</span></p>

                        <div class="progress-section">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progressText">0%</span>
                                <span id="etaText">-</span>
                            </div>
                        </div>
                    </div>

                    <div id="idleState">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h4>학습 대기 중</h4>
                            <p>학습을 시작하려면 위에서 설정을 구성하고 시작 버튼을 클릭하세요</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 학습 기록 -->
            <section class="training-history">
                <div class="history-card">
                    <h3 class="section-title">
                        <i class="fas fa-history"></i>
                        학습 기록
                    </h3>

                    <div id="historyList">
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <h4>학습 기록이 없습니다</h4>
                            <p>모델 학습을 시작해보세요</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let projects = [];
        let datasets = [];
        let selectedProjectId = null;
        let selectedDatasetId = null;

        const typeLabelMap = {
            anomaly: 'Anomaly Detection',
            classification: 'Classification',
            segmentation: 'Segmentation',
            detection: 'Object Detection'
        };
        const dsTypeToModelType = {
            classify: 'classification',
            obd: 'detection',
            seg: 'segmentation',
            anomal: 'anomaly'
        };

        function getURLParam(name) { return new URLSearchParams(location.search).get(name); }
        function setURLParam(name, value) {
            const url = new URL(location.href);
            if (value === null || value === undefined || value === '') url.searchParams.delete(name);
            else url.searchParams.set(name, value);
            history.replaceState({}, '', url);
        }

        /** =========================
         *  헤더/브레드크럼
         *  ========================= */
        function renderBreadcrumb(projectName, datasetName, modelType) {
            const bc = document.getElementById('breadcrumbNav');
            const typeText = modelType ? ` / ${typeLabelMap[modelType] || modelType}` : '';
            const projText = projectName ? `프로젝트(${projectName})` : '프로젝트';
            const dsText = datasetName ? `데이터셋(${datasetName})` : '데이터셋';

            bc.innerHTML = `
            <a href="/dashboard" class="breadcrumb-item">대시보드</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/ui/projects" class="breadcrumb-item">${projText}</a>
            <span class="breadcrumb-separator">/</span>
            <a href="/ui/datasets?project=${encodeURIComponent(selectedProjectId || '')}" class="breadcrumb-item">${dsText}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">모델 학습${typeText}</span>
        `;
        }

        /** =========================
         *  서버 연동 (datasets.html과 동일한 규약)
         *  ========================= */
        async function fetchProjects() {
            const res = await fetch('/api/projects');
            if (!res.ok) throw new Error('프로젝트 불러오기 실패');
            const list = await res.json();
            // createdAt 기준 오래된 순
            list.sort((a, b) => new Date(a.createdAt || a.created_at) - new Date(b.createdAt || b.created_at));
            return list;
        }

        async function fetchProjectDatasets(projectId) {
            const res = await fetch(`/api/projects/${projectId}/datasets`);
            if (!res.ok) throw new Error('데이터셋 불러오기 실패');
            return await res.json();
        }

        /** =========================
         *  셀렉터 채우기/동기화
         *  ========================= */
        function fillProjectSelectors() {
            const ids = ['projectSelector', 'trainingProjectSelect'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = '<option value="">프로젝트를 선택하세요</option>';
                projects.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; opt.textContent = p.name;
                    el.appendChild(opt);
                });
                el.value = selectedProjectId || '';
            });
        }

        function fillDatasetSelectors() {
            const header = document.getElementById('datasetSelectorHeader');
            const basic = document.getElementById('datasetSelect');
            const baseOpt = '<option value="">데이터셋을 선택하세요</option>';
            header.innerHTML = baseOpt; basic.innerHTML = baseOpt;

            datasets.forEach(d => {
                const opt1 = document.createElement('option');
                opt1.value = d.id; opt1.textContent = d.name;
                header.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = d.id; opt2.textContent = d.name;
                basic.appendChild(opt2);
            });

            header.style.display = 'inline-block';
            header.value = selectedDatasetId || '';
            basic.value = selectedDatasetId || '';
        }

        /** =========================
         *  백본 도움말/옵션 (type에 맞춰)
         *  ========================= */
        function applyBackboneByType(modelType) {
            const sel = document.getElementById('backboneSelect');
            const tip = sel.parentElement.querySelector('.help-icon .tooltip');
            if (modelType === 'anomaly' || !modelType) {
                sel.innerHTML = `
            <option value="wideresnet50">Wide ResNet-50</option>
            <option value="resnet18">ResNet-18</option>
            <option value="resnet50">ResNet-50</option>
            <option value="efficientnet_b0">EfficientNet-B0</option>
            `;
                tip.innerHTML = `
            이미지에서 특징을 추출하는 사전 훈련된 모델입니다.<br>
            • Wide ResNet-50: 가장 좋은 성능 (권장)<br>
            • ResNet-18: 빠른 속도, 가벼운 모델<br>
            • ResNet-50: 높은 정확도, 더 무거운 모델<br>
            • EfficientNet-B0: 메모리 효율적
            `;
            } else if (modelType === 'classification') {
                sel.innerHTML = `<option value="resnet50">ResNet-50 (추가 예정)</option>`;
                tip.innerHTML = `분류 백본은 곧 추가됩니다.`;
            } else if (modelType === 'segmentation') {
                sel.innerHTML = `<option value="unet">U-Net (추가 예정)</option>`;
                tip.innerHTML = `세그멘테이션 백본은 곧 추가됩니다.`;
            } else if (modelType === 'detection') {
                sel.innerHTML = `<option value="yolo">YOLO (추가 예정)</option>`;
                tip.innerHTML = `객체 검출 백본은 곧 추가됩니다.`;
            }
        }

        /** =========================
         *  URL → 화면 초기화
         *  ========================= */
        async function initializeFromURL() {
            // 1) URL 파라미터 파싱
            const projectParam = getURLParam('project');
            const datasetIdParam = getURLParam('dataset');
            const datasetNameParam = getURLParam('datasetName');
            let modelType = getURLParam('type'); // anomaly/classification/segmentation/detection

            // 2) 프로젝트 목록
            projects = await fetchProjects();

            // project 선택 복원(있으면)
            if (projectParam && projects.some(p => String(p.id) === String(projectParam))) {
                selectedProjectId = projectParam;
            } else {
                selectedProjectId = ''; // 비선택
            }
            fillProjectSelectors();

            // 3) 프로젝트가 있으면 해당 데이터셋 로드
            if (selectedProjectId) {
                datasets = await fetchProjectDatasets(selectedProjectId);

                // dataset 해석: id 우선, 없으면 name
                let found = null;
                if (datasetIdParam) {
                    found = datasets.find(d => String(d.id) === String(datasetIdParam));
                } else if (datasetNameParam) {
                    found = datasets.find(d => d.name === datasetNameParam);
                }
                selectedDatasetId = found ? found.id : '';

                // type이 없으면 데이터셋의 type -> modelType 매핑 시도
                if (!modelType && found && found.type) {
                    modelType = dsTypeToModelType[found.type] || 'anomaly';
                    setURLParam('type', modelType);
                }

                fillDatasetSelectors();
            } else {
                datasets = [];
                fillDatasetSelectors();
            }

            // 4) 헤더/기본설정 셀렉터 값 동기화
            document.getElementById('projectSelector').value = selectedProjectId || '';
            document.getElementById('trainingProjectSelect').value = selectedProjectId || '';
            document.getElementById('datasetSelectorHeader').value = selectedDatasetId || '';
            document.getElementById('datasetSelect').value = selectedDatasetId || '';

            // 5) 브레드크럼 & 백본 도움말
            const projectName = (projects.find(p => p.id === selectedProjectId) || {}).name || '';
            const datasetName = (datasets.find(d => d.id === selectedDatasetId) || {}).name || datasetNameParam || '';
            renderBreadcrumb(projectName, datasetName, modelType);
            applyBackboneByType(modelType);

            // 6) 기본 설정 내 값 사전 채우기(데이터셋명 표기용)
            //    서버의 /training/start는 dataset_name 이름을 받으니 id→이름 변환해서 넣게 함
            //    (startTraining()에서 읽습니다)
        }

        /** =========================
         *  이벤트
         *  ========================= */
        function wireEvents() {
            // 프로젝트 변경(헤더/기본설정 동일 동작)
            const onProjectChange = async (projectId) => {
                selectedProjectId = projectId || '';
                setURLParam('project', selectedProjectId || null);

                // 프로젝트 변경 시 데이터셋 초기화
                selectedDatasetId = '';
                setURLParam('dataset', null);
                setURLParam('datasetName', null);

                if (selectedProjectId) {
                    datasets = await fetchProjectDatasets(selectedProjectId);
                } else {
                    datasets = [];
                }
                fillDatasetSelectors();

                const projectName = (projects.find(p => p.id === selectedProjectId) || {}).name || '';
                renderBreadcrumb(projectName, '', getURLParam('type') || 'anomaly');
            };

            document.getElementById('projectSelector').addEventListener('change', e => {
                document.getElementById('trainingProjectSelect').value = e.target.value;
                onProjectChange(e.target.value);
            });
            document.getElementById('trainingProjectSelect').addEventListener('change', e => {
                document.getElementById('projectSelector').value = e.target.value;
                onProjectChange(e.target.value);
            });

            // 데이터셋 변경(헤더/기본설정 양방향 동기화)
            const onDatasetChange = (datasetId) => {
                selectedDatasetId = datasetId || '';
                const ds = datasets.find(d => d.id === selectedDatasetId);
                const projectName = (projects.find(p => p.id === selectedProjectId) || {}).name || '';
                const datasetName = ds ? ds.name : '';
                setURLParam('dataset', selectedDatasetId || null);
                setURLParam('datasetName', datasetName || null);

                // type 자동 결정(데이터셋 실제 type 사용)
                if (ds && ds.type) {
                    const modelType = dsTypeToModelType[ds.type] || 'anomaly';
                    setURLParam('type', modelType);
                    applyBackboneByType(modelType);
                    renderBreadcrumb(projectName, datasetName, modelType);
                } else {
                    renderBreadcrumb(projectName, datasetName, getURLParam('type'));
                }
            };

            document.getElementById('datasetSelectorHeader').addEventListener('change', e => {
                document.getElementById('datasetSelect').value = e.target.value;
                onDatasetChange(e.target.value);
            });
            document.getElementById('datasetSelect').addEventListener('change', e => {
                document.getElementById('datasetSelectorHeader').value = e.target.value;
                onDatasetChange(e.target.value);
            });

            // 공용 sync 유틸
            function sync(sid, iid, cb) {
                const s = document.getElementById(sid);
                const i = document.getElementById(iid);
                if (!s || !i) return;

                // 슬라이더는 즉시 반영 + 콜백
                s.addEventListener('input', () => {
                    i.value = s.value;
                    cb && cb('slider');
                });

                // 숫자 인풋은 타이핑 허용 → 유효할 때/엔터/블러에 커밋
                let t = null;
                const tryCommit = () => cb && cb('input');
                i.addEventListener('input', () => {
                    s.value = i.value;
                    if (t) clearTimeout(t);
                    t = setTimeout(() => {
                        const min = parseInt(i.min || '0', 10);
                        const max = parseInt(i.max || '100', 10);
                        const v = parseInt(i.value, 10);
                        if (!Number.isNaN(v) && v >= min && v <= max) tryCommit();
                    }, 250);
                });
                i.addEventListener('change', tryCommit);
                i.addEventListener('blur', tryCommit);
                i.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); i.blur(); tryCommit(); } });
            }

            // ========= [여기부터] 분할 상수/유틸을 최상단에 배치 (TDZ 방지) =========
            const TR_MIN = 50, TR_MAX = 90;
            const VR_MIN = 10, VR_MAX = 40;
            const TE_MIN = 0, TE_MAX = 40;

            const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

            function setTriple(baseId, v) {
                const s = document.getElementById(baseId + 'Slider');
                const i = document.getElementById(baseId + 'Input');
                const label = document.getElementById(baseId.replace('Ratio', '') + 'Percentage');
                if (s) s.value = String(v);
                if (i) i.value = String(v);
                if (label) label.textContent = `${v}%`;
            }

            // S = 100 - test 내부에서 train/val 페어를 경계에 맞게 보정
            function adjustPairToBounds(S, tr, vr) {
                if (tr + vr !== S) vr = S - tr;
                if (vr < VR_MIN) { vr = VR_MIN; tr = S - vr; }
                if (vr > VR_MAX) { vr = VR_MAX; tr = S - vr; }
                if (tr < TR_MIN) { tr = TR_MIN; vr = S - tr; }
                if (tr > TR_MAX) { tr = TR_MAX; vr = S - tr; }
                tr = clamp(tr, TR_MIN, TR_MAX);
                vr = clamp(S - tr, VR_MIN, VR_MAX);
                tr = S - vr;
                return { tr, vr };
            }

            function onTrainChange(src) {
                const te = clamp(parseInt(document.getElementById('testRatioInput').value || '0', 10), TE_MIN, TE_MAX);
                const S = 100 - te;
                const trRaw = parseInt(document.getElementById(src === 'input' ? 'trainRatioInput' : 'trainRatioSlider').value || '0', 10);
                let tr = clamp(trRaw, TR_MIN, TR_MAX);
                let vr = S - tr;
                ({ tr, vr } = adjustPairToBounds(S, tr, vr));
                setTriple('trainRatio', tr);
                setTriple('valRatio', vr);
                setTriple('testRatio', te);
            }

            function onValChange(src) {
                const te = clamp(parseInt(document.getElementById('testRatioInput').value || '0', 10), TE_MIN, TE_MAX);
                const S = 100 - te;
                const vrRaw = parseInt(document.getElementById(src === 'input' ? 'valRatioInput' : 'valRatioSlider').value || '0', 10);
                let vr = clamp(vrRaw, VR_MIN, VR_MAX);
                let tr = S - vr;
                ({ tr, vr } = adjustPairToBounds(S, tr, vr));
                setTriple('trainRatio', tr);
                setTriple('valRatio', vr);
                setTriple('testRatio', te);
            }

            function onTestChange(src) {
                const teRaw = parseInt(document.getElementById(src === 'input' ? 'testRatioInput' : 'testRatioSlider').value || '0', 10);
                const te = clamp(teRaw, TE_MIN, TE_MAX);
                const S = 100 - te;

                let currTr = clamp(parseInt(document.getElementById('trainRatioInput').value || '0', 10), TR_MIN, TR_MAX);
                let currVr = clamp(parseInt(document.getElementById('valRatioInput').value || '0', 10), VR_MIN, VR_MAX);
                let sumTV = currTr + currVr;
                if (sumTV < 60) { currTr = 50; currVr = 10; sumTV = 60; }

                const r = currTr / sumTV;
                const rawTrain = r * S;
                let tr = Number.isInteger(rawTrain) ? rawTrain : Math.ceil(rawTrain);
                let vr = S - tr;

                ({ tr, vr } = adjustPairToBounds(S, tr, vr));
                setTriple('trainRatio', tr);
                setTriple('valRatio', vr);
                setTriple('testRatio', te);
            }
            // ========= [여기까지] TDZ 방지 재배치 완료 =========

            // 학습률/샘플링 동기화 (한 번만 바인딩)
            sync('learningRateSlider', 'learningRateInput');
            sync('samplingRatioSlider', 'samplingRatioInput');

            // 분할 비율 바인딩 (한 번만 바인딩)
            sync('trainRatioSlider', 'trainRatioInput', onTrainChange);
            sync('valRatioSlider', 'valRatioInput', onValChange);
            sync('testRatioSlider', 'testRatioInput', onTestChange);

            // 초기 정리 (현재 값 기준으로 일관화, 한 번만 호출)
            onTestChange('input');
        }

        /** =========================
         *  학습 매니저 (기존 코드 사용 + 인스턴스 생성)
         *  ========================= */
        class TrainingManager {
            constructor() { this.progressInterval = null; this.isTraining = false; }
            async startTraining(config) {
                const res = await fetch('/training/start', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(config)
                });
                const data = await res.json();
                if (data.success) {
                    this.isTraining = true;
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-flex';
                    document.getElementById('statusBadge').textContent = '학습중';
                    document.getElementById('statusBadge').className = 'status-badge status-training';
                    document.getElementById('trainingInfo').style.display = 'block';
                    document.getElementById('idleState').style.display = 'none';
                    document.getElementById('currentModel').textContent = `${config.backbone} (${data.dataset_type || '-'})`;
                    document.getElementById('currentDataset').textContent = config.dataset_name || '-';
                    document.getElementById('startTime').textContent = new Date().toLocaleString();
                    this.progressInterval = setInterval(refreshTraining, 3000);
                    return { success: true, message: data.message };
                }
                throw new Error(data.error || '학습 시작 실패');
            }
            async stopTraining() {
                const res = await fetch('/training/stop', { method: 'POST' });
                const data = await res.json();
                clearInterval(this.progressInterval); this.progressInterval = null; this.isTraining = false;
                document.getElementById('startBtn').style.display = 'inline-flex';
                document.getElementById('stopBtn').style.display = 'none';
                document.getElementById('statusBadge').textContent = '대기중';
                document.getElementById('statusBadge').className = 'status-badge status-idle';
                document.getElementById('trainingInfo').style.display = 'none';
                document.getElementById('idleState').style.display = 'block';
                return data;
            }
        }
        const trainingManager = new TrainingManager();

        /** =========================
         *  진행률 폴링(기존 엔드포인트 그대로)
         *  ========================= */
        async function refreshTraining() {
            try {
                const res = await fetch('/training/status');
                const data = await res.json();
                if (data.is_training_active) {
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'inline-flex';
                    document.getElementById('statusBadge').textContent = '학습중';
                    document.getElementById('statusBadge').className = 'status-badge status-training';
                    document.getElementById('trainingInfo').style.display = 'block';
                    document.getElementById('idleState').style.display = 'none';
                    const p = (data.current_training?.progress || 0);
                    document.getElementById('progressFill').style.width = p + '%';
                    document.getElementById('progressText').textContent = p + '%';
                } else {
                    document.getElementById('startBtn').style.display = 'inline-flex';
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('statusBadge').textContent = '대기중';
                    document.getElementById('statusBadge').className = 'status-badge status-idle';
                    document.getElementById('trainingInfo').style.display = 'none';
                    document.getElementById('idleState').style.display = 'block';
                }
            } catch (e) { console.error('학습 상태 새로고침 실패:', e); }
        }

        /** =========================
         *  시작/중단 버튼 핸들러
         *  ========================= */
        async function startTraining() {
            if (!selectedDatasetId) {
                alert('데이터셋을 선택해주세요.');
                return;
            }
            const ds = datasets.find(d => d.id === selectedDatasetId);
            const datasetName = ds?.name;
            if (!datasetName) { alert('데이터셋 이름을 확인할 수 없습니다.'); return; }

            const trainPct = parseInt(document.getElementById('trainRatioInput').value, 10) || 0;
            const valPct = parseInt(document.getElementById('valRatioInput').value, 10) || 0;
            const testPct = parseInt(document.getElementById('testRatioInput').value, 10) || 0;

            const imageSize = parseInt(document.getElementById('imageSize').value, 10);
            let resizeSize = parseInt(document.getElementById('resizeSize').value, 10);

            // 검증/보정: 이미지 크기는 리사이즈보다 클 수 없음
            if (Number.isFinite(imageSize) && Number.isFinite(resizeSize) && imageSize > resizeSize) {
                resizeSize = imageSize;
                // 필요 시 안내: alert('리사이즈(전처리)를 이미지 크기 이상으로 자동 보정했습니다.');
            }

            const epochs = parseInt(document.getElementById('epochs').value, 10) || 10;
            const batchSize = parseInt(document.getElementById('batchSize').value, 10) || 32;
            const learningRate = parseFloat(document.getElementById('learningRateInput').value) || 0.001;

            const config = {
                dataset_name: datasetName,
                backbone: document.getElementById('backboneSelect').value,
                layers: ["layer2", "layer3"],
                anomaly_scorer_num_nn: 7,
                sampling_ratio: parseFloat(document.getElementById('samplingRatioInput').value),
                resize_size: resizeSize,
                image_size: imageSize,
                gpu_id: 0,

                // 추가 전송
                training_type: document.getElementById('trainingType').value,
                learning_rate: learningRate,
                batch_size: batchSize,
                epochs: epochs,
                train_ratio: trainPct / 100,
                val_ratio: valPct / 100,
                test_ratio: testPct / 100
            };

            try {
                const r = await trainingManager.startTraining(config);
                alert(r.message || '학습을 시작했습니다.');
            } catch (e) { alert('학습 시작 실패: ' + e.message); }
        }

        async function stopTraining() {
            if (!confirm('학습을 중단하시겠습니까?')) return;
            try {
                const r = await trainingManager.stopTraining();
                alert(r.message || '학습이 중단되었습니다.');
            } catch (e) { alert('학습 중단 실패: ' + e.message); }
        }

        /** =========================
         *  부트스트랩
         *  ========================= */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializeFromURL();
                wireEvents();
                refreshTraining();
            } catch (e) {
                console.error(e);
            }
        });
    </script>
</body>

</html>